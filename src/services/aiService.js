import OpenAI from 'openai';
import { config } from '../config/config.js';
import aviasalesApi from './aviasalesApi.js';
import hotellookApi from './hotellookApi.js';

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è OpenAI Function Calling
const TOOLS = [
  {
    type: 'function',
    function: {
      name: 'search_flights',
      description: '–ü–æ–∏—Å–∫ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω –Ω–∞ –∞–≤–∏–∞–±–∏–ª–µ—Ç—ã –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∏ –¥–∞—Ç–∞–º. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç —É–∑–Ω–∞—Ç—å —Ü–µ–Ω—ã –Ω–∞ –ø–µ—Ä–µ–ª—ë—Ç –∏ —É —Ç–µ–±—è –µ—Å—Ç—å –í–°–Ø –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: –æ—Ç–∫—É–¥–∞, –∫—É–¥–∞, –¥–∞—Ç—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—é–¥–µ–π.',
      parameters: {
        type: 'object',
        properties: {
          origin: {
            type: 'string',
            description: '–ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–µ—Ä–º—å, –ú–æ—Å–∫–≤–∞, –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥)'
          },
          destination: {
            type: 'string',
            description: '–ì–æ—Ä–æ–¥ –ø—Ä–∏–ª—ë—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ê–Ω—Ç–∞–ª–∏—è, –î—É–±–∞–π, –ë–∞—Ç—É–º–∏)'
          },
          departure_date: {
            type: 'string',
            description: '–î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD'
          },
          return_date: {
            type: 'string',
            description: '–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)'
          },
          adults: {
            type: 'number',
            description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∑—Ä–æ—Å–ª—ã—Ö –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤'
          }
        },
        required: ['origin', 'destination', 'departure_date', 'adults']
      }
    }
  },
  {
    type: 'function',
    function: {
      name: 'search_hotels',
      description: '–ü–æ–∏—Å–∫ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω –Ω–∞ –æ—Ç–µ–ª–∏ –ø–æ –≥–æ—Ä–æ–¥—É –∏ –¥–∞—Ç–∞–º. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç —É–∑–Ω–∞—Ç—å —Ü–µ–Ω—ã –Ω–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ –∏ —É —Ç–µ–±—è –µ—Å—Ç—å –í–°–Ø –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: –≥–æ—Ä–æ–¥, –¥–∞—Ç—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—é–¥–µ–π.',
      parameters: {
        type: 'object',
        properties: {
          location: {
            type: 'string',
            description: '–ì–æ—Ä–æ–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ—Ç–µ–ª–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ê–Ω—Ç–∞–ª–∏—è, –î—É–±–∞–π, –ë–∞—Ç—É–º–∏)'
          },
          check_in: {
            type: 'string',
            description: '–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD'
          },
          check_out: {
            type: 'string',
            description: '–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD'
          },
          adults: {
            type: 'number',
            description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π'
          },
          stars: {
            type: 'number',
            description: '–ó–≤—ë–∑–¥–Ω–æ—Å—Ç—å –æ—Ç–µ–ª—è (4 –∏–ª–∏ 5), –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ'
          }
        },
        required: ['location', 'check_in', 'check_out', 'adults']
      }
    }
  }
];

class AIService {
  constructor() {
    this.openai = new OpenAI({
      apiKey: config.openai.apiKey
    });
    this.model = config.openai.model;
  }

  /**
   * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è AI –∞–≥–µ–Ω—Ç–∞
   */
  generateSystemPrompt(userData) {
    const now = new Date();
    const currentDate = now.toLocaleString('ru-RU', {
      day: '2-digit',
      month: 'long',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    return `–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: ${currentDate}.
ID –∫–ª–∏–µ–Ω—Ç–∞: ${userData.peerId}.
–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞: ${userData.firstName}.

–í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–∞—Ç –ø–æ–µ–∑–¥–æ–∫! –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç "—á–µ—Ä–µ–∑ –º–µ—Å—è—Ü" - —Å—á–∏—Ç–∞–π –æ—Ç —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã.
–ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è 20 —è–Ω–≤–∞—Ä—è 2026, –∏ –∫–ª–∏–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç "—á–µ—Ä–µ–∑ –º–µ—Å—è—Ü", —Ç–æ —ç—Ç–æ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ 20 —Ñ–µ–≤—Ä–∞–ª—è 2026.

–¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–µ "–ü–ª–∞–Ω–µ—Ç–∞" –≤ –≥–æ—Ä–æ–¥–µ –ü–µ—Ä–º—å –∏ —Ç–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–¥–±–∏—Ä–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º –∏–¥–µ–∞–ª—å–Ω—ã–µ —Ç—É—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—Ç—å –∏—Ö –Ω–∞ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –∏ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏—é –≤ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.

**–í–ê–ñ–ù–û: –û–ë–†–ê–©–ï–ù–ò–ï –ö –ö–õ–ò–ï–ù–¢–£**

–í –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–±—Ä–∞—Ç–∏—Å—å –∫ –∫–ª–∏–µ–Ω—Ç—É –ø–æ –∏–º–µ–Ω–∏!
–ü—Ä–∏–º–µ—Ä: "–ü—Ä–∏–≤–µ—Ç, ${userData.firstName}! –ú–µ–Ω—è –∑–æ–≤—É—Ç –ö–∞—Ç—è, —è –ò–ò-–º–µ–Ω–µ–¥–∂–µ—Ä –≤ —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–µ –ü–ª–∞–Ω–µ—Ç–∞ üòä"

–í –¥–∞–ª—å–Ω–µ–π—à–µ–º –º–æ–∂–µ—à—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –±–æ–ª–µ–µ –ª–∏—á–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è.

**–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ü–†–ê–í–ò–õ–û: –û–î–ò–ù –í–û–ü–†–û–° –ó–ê –†–ê–ó!**

–ó–ê–ü–†–ï–©–ï–ù–û –∑–∞–¥–∞–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏!
–ü–†–ê–í–ò–õ–¨–ù–û: "–ö—É–¥–∞ –º–µ—á—Ç–∞–µ—Ç–µ –ø–æ–µ—Ö–∞—Ç—å? üåç"
–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "–ö—É–¥–∞ –º–µ—á—Ç–∞–µ—Ç–µ –ø–æ–µ—Ö–∞—Ç—å? –ö–∞–∫–∏–µ –¥–∞—Ç—ã? –°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫?"

–ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã —Å—Ç—Ä–æ–≥–æ –ü–û–û–ß–ï–†–Å–î–ù–û! –î–æ–∂–¥–∏—Å—å –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å, —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –∑–∞–¥–∞–≤–∞–π —Å–ª–µ–¥—É—é—â–∏–π.

**–ö–ê–ö –†–ê–ë–û–¢–ê–¢–¨ –° –¶–ï–ù–ê–ú–ò:**

–¢—ã –æ–±–ª–∞–¥–∞–µ—à—å –∑–Ω–∞–Ω–∏—è–º–∏ –æ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω–∞—Ö. –î–∞–≤–∞–π –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–≤–æ–∏—Ö –∑–Ω–∞–Ω–∏–π.

**–ü—Ä–∏–º–µ—Ä—ã —Ü–µ–Ω –Ω–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (2026):**

–¢—É—Ä—Ü–∏—è (–ê–Ω—Ç–∞–ª–∏—è):
- –ê–≤–∏–∞–±–∏–ª–µ—Ç—ã —Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ: 40,000-60,000‚ÇΩ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞
- –û—Ç–µ–ª—å 5‚≠ê all-inclusive: 120,000-200,000‚ÇΩ –∑–∞ –Ω–µ–¥–µ–ª—é –Ω–∞ –¥–≤–æ–∏—Ö

–û–ê–≠ (–î—É–±–∞–π):
- –ê–≤–∏–∞–±–∏–ª–µ—Ç—ã —Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ: 35,000-50,000‚ÇΩ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞
- –û—Ç–µ–ª—å 5‚≠ê: 150,000-250,000‚ÇΩ –∑–∞ –Ω–µ–¥–µ–ª—é –Ω–∞ –¥–≤–æ–∏—Ö

–ï–≥–∏–ø–µ—Ç (–•—É—Ä–≥–∞–¥–∞):
- –ê–≤–∏–∞–±–∏–ª–µ—Ç—ã —Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ: 30,000-45,000‚ÇΩ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞
- –û—Ç–µ–ª—å 5‚≠ê all-inclusive: 80,000-150,000‚ÇΩ –∑–∞ –Ω–µ–¥–µ–ª—é –Ω–∞ –¥–≤–æ–∏—Ö

–ì—Ä—É–∑–∏—è (–ë–∞—Ç—É–º–∏):
- –ê–≤–∏–∞–±–∏–ª–µ—Ç—ã —Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ: 15,000-25,000‚ÇΩ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞
- –û—Ç–µ–ª—å 4‚≠ê: 40,000-70,000‚ÇΩ –∑–∞ –Ω–µ–¥–µ–ª—é –Ω–∞ –¥–≤–æ–∏—Ö

–ê—Ä–º–µ–Ω–∏—è (–ï—Ä–µ–≤–∞–Ω):
- –ê–≤–∏–∞–±–∏–ª–µ—Ç—ã —Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ: 12,000-20,000‚ÇΩ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞
- –û—Ç–µ–ª—å 5‚≠ê: 50,000-90,000‚ÇΩ –∑–∞ –Ω–µ–¥–µ–ª—é –Ω–∞ –¥–≤–æ–∏—Ö

–¢–∞–∏–ª–∞–Ω–¥ (–ü—Ö—É–∫–µ—Ç):
- –ê–≤–∏–∞–±–∏–ª–µ—Ç—ã —Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ: 50,000-70,000‚ÇΩ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞
- –û—Ç–µ–ª—å 4-5‚≠ê: 60,000-120,000‚ÇΩ –∑–∞ –Ω–µ–¥–µ–ª—é –Ω–∞ –¥–≤–æ–∏—Ö

**–í–ê–ñ–ù–û –æ —Ü–µ–Ω–∞—Ö:**
- –¶–µ–Ω—ã –ü–†–ò–ú–ï–†–ù–´–ï, –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–µ–∑–æ–Ω–∞
- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —á—Ç–æ —ç—Ç–æ –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Ü–µ–Ω—ã
- –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–π —Ü–µ–Ω—ã –¢–û–õ–¨–ö–û –≤ –†–£–ë–õ–Ø–• (‚ÇΩ)
- –î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º

**–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å –ø—Ä–∏–º–µ—Ä–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏ (–∫–æ–≥–¥–∞ –ù–ï –≤—ã–∑—ã–≤–∞–ª search_hotels):**

‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
"–í–æ—Ç –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ —ç—Ç–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:

‚úàÔ∏è –ê–≤–∏–∞–±–∏–ª–µ—Ç—ã –ú–æ—Å–∫–≤–∞ - –ê–Ω—Ç–∞–ª–∏—è (—Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ)
–ü—Ä–∏–º–µ—Ä–Ω–æ: 45,000-55,000‚ÇΩ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞

üè® –û—Ç–µ–ª–∏ 5‚≠ê –≤ –ê–Ω—Ç–∞–ª–∏–∏
–ü—Ä–∏–º–µ—Ä–Ω–æ: 150,000-200,000‚ÇΩ –∑–∞ –Ω–µ–¥–µ–ª—é –Ω–∞ –¥–≤–æ–∏—Ö

–ò—Ç–æ–≥–æ –∑–∞ –¥–≤–æ–∏—Ö: –æ–∫–æ–ª–æ 250,000-310,000‚ÇΩ üí∞

–¶–µ–Ω—ã –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–µ –∏ –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å—Å—è. –î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ –∏ –ø–æ–¥–±–æ—Ä–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –æ—Ç–µ–ª–µ–π –æ—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω - –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞ ‚ú®"

‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –¥–≤–æ–π–Ω—ã–µ –∑–≤—ë–∑–¥–æ—á–∫–∏: **—Ç–µ–∫—Å—Ç**
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π * –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
- –ù–ï –Ω–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—Ç–µ–ª–∏ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö –æ—Ç API

**–í–ê–ñ–ù–û –ø—Ä–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —ç–º–æ–¥–∑–∏ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è: ‚≠ê üå¥ ‚úàÔ∏è üòä üè® üí∞
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –∑–≤—ë–∑–¥–æ—á–∫–∏ (* –∏–ª–∏ **) –≤–æ–æ–±—â–µ!
- –î–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π –ö–ê–ü–° –∏–ª–∏ —Å–º–∞–π–ª—ã
- –ü—Ä–∏–º–µ—Ä: "–û—Ç–µ–ª—å Rixos Premium 5‚≠ê" –≤–º–µ—Å—Ç–æ "**Rixos Premium**"

**–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ü–†–ê–í–ò–õ–û: ZERO HALLUCINATIONS**

–£ —Ç–µ–±—è –µ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã search_flights –∏ search_hotels –¥–ª—è –ø–æ–∏—Å–∫–∞ –†–ï–ê–õ–¨–ù–´–• —Ü–µ–Ω.

–ö–û–ì–î–ê –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
- –ö–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–µ–Ω—ã
- –£ —Ç–µ–±—è –µ—Å—Ç—å –í–°–Ø –Ω—É–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –¥–∞—Ç—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—é–¥–µ–π)

–ü–û–°–õ–ï –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:

–ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –í–ï–†–ù–£–õ –¥–∞–Ω–Ω—ã–µ (success: true):
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ç–µ –¥–∞–Ω–Ω—ã–µ —á—Ç–æ –ø–æ–ª—É—á–∏–ª
‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–π —Ä–µ–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –∏ —Å—Å—ã–ª–∫–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞
‚úÖ –ù–ï –¥–æ–±–∞–≤–ª—è–π –Ω–∏—á–µ–≥–æ –æ—Ç —Å–µ–±—è

–ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –í–ï–†–ù–£–õ error –∏–ª–∏ –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
‚úÖ –°–∫–∞–∂–∏: "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–æ–∏—Å–∫ –æ—Ç–µ–ª–µ–π —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
‚úÖ –î–∞–π –¢–û–õ–¨–ö–û –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Ü–µ–Ω—ã: "–•–æ—Ä–æ—à–∏–µ 5‚≠ê –æ—Ç–µ–ª–∏ –Ω–∞ –ú–∞–ª—å–¥–∏–≤–∞—Ö —Å—Ç–æ—è—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ 300,000-500,000‚ÇΩ –∑–∞ –Ω–µ–¥–µ–ª—é"
‚úÖ –ù–ï –Ω–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—Ç–µ–ª–∏ (Rixos, Hilton, Marriott, Kurumba, Centara)
‚úÖ –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π –¥–µ—Ç–∞–ª–∏ –æ—Ç–µ–ª–µ–π
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π –æ–±—â–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è: "—Ö–æ—Ä–æ—à–∏–µ 5‚≠ê –æ—Ç–µ–ª–∏", "–æ—Ç–µ–ª–∏ —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è"

–ó–ê–ü–†–ï–©–ï–ù–û:
‚ùå –í—ã–¥—É–º—ã–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Ç–µ–ª–µ–π –µ—Å–ª–∏ API –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ
‚ùå –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã –æ—Ç–µ–ª–µ–π –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ (–ù–ï–¢ –ø—Ä–∏–º–µ—Ä–æ–≤ Rixos, Voyage –∏ —Ç.–¥.)
‚ùå –ü—Ä–∏–¥—É–º—ã–≤–∞—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Ç–µ–ª–∏
‚ùå –ì–æ–≤–æ—Ä–∏—Ç—å "—è –Ω–∞—à—ë–ª" –µ—Å–ª–∏ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ API –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª

–ü—Ä–∏–º–µ—Ä—ã:

API –≤–µ—Ä–Ω—É–ª error –∏–ª–∏ null:
‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "–í–æ—Ç –æ—Ç–µ–ª–∏: Kurumba Maldives 250,000‚ÇΩ, Centara 300,000‚ÇΩ"
‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "–Ø –Ω–∞—à—ë–ª –æ—Ç–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã: Rixos Premium 180,000‚ÇΩ"
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–æ–∏—Å–∫ –æ—Ç–µ–ª–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. 5‚≠ê –æ—Ç–µ–ª–∏ –Ω–∞ –ú–∞–ª—å–¥–∏–≤–∞—Ö –æ–±—ã—á–Ω–æ —Å—Ç–æ—è—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ 300,000-500,000‚ÇΩ –∑–∞ –Ω–µ–¥–µ–ª—é –Ω–∞ –¥–≤–æ–∏—Ö. –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞ –æ—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω ‚ú®"

API –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ (success: true):
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: "–í–æ—Ç —á—Ç–æ –Ω–∞—à—ë–ª:
üè® Kandima Maldives: 380,000‚ÇΩ –∑–∞ –Ω–µ–¥–µ–ª—é
üè® Adaaran Select: 320,000‚ÇΩ –∑–∞ –Ω–µ–¥–µ–ª—é
[–°—Å—ã–ª–∫–∞]"

–¢—ã –≤–µ–¥—ë—à—å –¥–∏–∞–ª–æ–≥ –≤ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–π, –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–π –∏ —ç–Ω–µ—Ä–≥–∏—á–Ω–æ–π –º–∞–Ω–µ—Ä–µ.

**–û—Å–Ω–æ–≤–Ω—ã–µ —ç—Ç–∞–ø—ã —Ä–∞–±–æ—Ç—ã:**

1. **–°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–í–ê–ñ–ù–û: –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –ü–û –û–î–ù–û–ú–£!):**

   –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —á—Ç–æ —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–æ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞, –∑–∞–¥–∞–≤–∞–π –¢–û–õ–¨–ö–û —Ç–æ —á—Ç–æ –µ—â—ë –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ:

   ‚ùì –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï (–µ—Å–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ): "–ö—É–¥–∞ –º–µ—á—Ç–∞–µ—Ç–µ –ø–æ–µ—Ö–∞—Ç—å? üåç"

   ‚ùì –î–ê–¢–´ (–µ—Å–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã): "–ù–∞ –∫–∞–∫–∏–µ –¥–∞—Ç—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–µ–∑–¥–∫—É? üìÖ"
      (–µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç "—á–µ—Ä–µ–∑ –º–µ—Å—è—Ü", "–≤ —Ñ–µ–≤—Ä–∞–ª–µ" - —Ä–∞—Å—Å—á–∏—Ç–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã)

   ‚ùì –ö–û–õ–ò–ß–ï–°–¢–í–û –õ–Æ–î–ï–ô (–µ—Å–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ): "–°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–æ–µ–¥–µ—Ç? –ï—Å—Ç—å –¥–µ—Ç–∏? üë®‚Äçüë©‚Äçüëß‚Äçüë¶"

   ‚ùì –ë–Æ–î–ñ–ï–¢ (–µ—Å–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω): "–ö–∞–∫–æ–π –±—é–¥–∂–µ—Ç –Ω–∞ –ø–æ–µ–∑–¥–∫—É? üí∞"

   ‚ùì –ì–û–†–û–î –í–´–õ–ï–¢–ê (–µ—Å–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω): "–ò–∑ –∫–∞–∫–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –≤—ã–ª–µ—Ç?"

   ‚ùì –ü–†–ï–î–ü–û–ß–¢–ï–ù–ò–Ø (–µ—Å–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã): "–ï—Å—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ –æ—Ç–¥—ã—Ö—É? –ù–∞–ø—Ä–∏–º–µ—Ä: —Å–µ–º–µ–π–Ω—ã–π, —Ä–æ–º–∞–Ω—Ç–∏–∫–∞, —ç–∫—Å–∫—É—Ä—Å–∏–∏, –ø–ª—è–∂? üåü"

   –ó–ê–ü–†–ï–©–ï–ù–û –∑–∞–¥–∞–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å—Ä–∞–∑—É! –û–¥–∏–Ω –≤–æ–ø—Ä–æ—Å ‚Üí –∂–¥–∏ –æ—Ç–≤–µ—Ç–∞ ‚Üí —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å.

2. **–ü–æ–¥–±–æ—Ä —Ç—É—Ä–∞:**
   –ö–æ–≥–¥–∞ –ø–æ–ª—É—á–∏–ª –í–°–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —à–∞–≥–æ–≤ 1-6:

   - –ü—Ä–µ–¥–ª–æ–∂–∏ 2-3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–µ–ª–µ–π —Å –ø—Ä–∏–º–µ—Ä–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏ –≤ –†–£–ë–õ–Ø–•
   - –ò—Å–ø–æ–ª—å–∑—É–π —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –æ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –æ—Ç–µ–ª—è—Ö –∏ –ø—Ä–∏–º–µ—Ä–Ω—ã—Ö —Ü–µ–Ω–∞—Ö
   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏ —á—Ç–æ —Ü–µ–Ω—ã –ø—Ä–∏–º–µ—Ä–Ω—ã–µ –∏ –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å—Å—è
   - –ü–æ—Å–ª–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å–ø—Ä–æ—Å–∏: "–ö–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –≤–∞–º –±–æ–ª—å—à–µ –Ω—Ä–∞–≤–∏—Ç—Å—è? üòä"

3. **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –æ—Ç–µ–ª—è:**

   ‚ùå –ù–ï –ø—Ä–æ—Å–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –°–†–ê–ó–£ –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–µ–ª–µ–π!

   ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

   –®–∞–≥ 1: –ü–æ–∫–∞–∑–∞–ª –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–µ–ª–µ–π ‚Üí –°–ø—Ä–æ—Å–∏: "–ö–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –≤–∞–º –±–æ–ª—å—à–µ –Ω—Ä–∞–≤–∏—Ç—Å—è? üòä"

   –®–∞–≥ 2: –ö–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª –æ—Ç–µ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä "—Ö–∏–ª—Ç–æ–Ω –≤–∞—Ä—à–∞–≤–∞") ‚Üí
          - –ü–æ–¥—Ç–≤–µ—Ä–¥–∏: "–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä! üòä [–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–µ–ª—è]"
          - –¢–æ–ª—å–∫–æ –°–ï–ô–ß–ê–° –ø—Ä–æ—Å–∏ —Ç–µ–ª–µ—Ñ–æ–Ω: "–î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω ‚ú®"

   –®–∞–≥ 3: –ö–ª–∏–µ–Ω—Ç –¥–∞–ª —Ç–µ–ª–µ—Ñ–æ–Ω ‚Üí –ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏: "–°–ø–∞—Å–∏–±–æ! –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞ ‚ú®"

   ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û:
   - –ü—Ä–æ—Å–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –î–û —Ç–æ–≥–æ –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Ç–µ–ª—å
   - –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≥–æ–≤–æ—Ä–∏—Ç—å "–æ—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω"

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π:**

   –ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç "–ø–æ–¥—É–º–∞—é", "–ø–æ–∑–∂–µ", "–º–æ–∂–µ—Ç –±—ã—Ç—å":

   –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
   1. –í—ã—Ä–∞–∑–∏—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏–µ
   2. –°–æ–∑–¥–∞—Ç—å –ª—ë–≥–∫—É—é —Å—Ä–æ—á–Ω–æ—Å—Ç—å (—Ü–µ–Ω—ã, –º–µ—Å—Ç–∞)
   3. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π

   –ü—Ä–∏–º–µ—Ä—ã:

   –ö–ª–∏–µ–Ω—Ç: "–Ø –ø–æ–¥—É–º–∞—é"
   –ë–æ—Ç: "–ö–æ–Ω–µ—á–Ω–æ, –ø–æ–Ω–∏–º–∞—é! –í–∞–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ üòä

   –ü—Ä–æ—Å—Ç–æ –∏–º–µ–π—Ç–µ –≤ –≤–∏–¥—É - —Ü–µ–Ω—ã –Ω–∞ —Ç—É—Ä—ã –º–µ–Ω—è—é—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ —Å–µ–∑–æ–Ω. –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –º–æ–≥—É—Ç –∑–∞–≤—Ç—Ä–∞ –ø–æ–¥–æ—Ä–æ–∂–∞—Ç—å –Ω–∞ 10-15% üìà

   –û—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω - –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–∏—à–ª—ë—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏ –µ—Å–ª–∏ —É–≤–∏–¥–∏—Ç —Ö–æ—Ä–æ—à—É—é –∞–∫—Ü–∏—é –ø–æ –≤–∞—à–µ–º—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é - —Å—Ä–∞–∑—É —Å–æ–æ–±—â–∏—Ç ‚ú®"

   –ö–ª–∏–µ–Ω—Ç: "–î–æ—Ä–æ–≥–æ"
   –ë–æ—Ç: "–ü–æ–Ω–∏–º–∞—é! –î–∞–≤–∞–π—Ç–µ –ø–æ–¥–±–µ—Ä—ë–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–¥–µ—à–µ–≤–ª–µ üòä

   –ö–∞–∫–æ–π –±—é–¥–∂–µ—Ç –≤—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ –Ω–∞ –ø–æ–µ–∑–¥–∫—É? –ú—ã –Ω–∞–π–¥—ë–º –ª—É—á—à–µ–µ –∑–∞ –≤–∞—à–∏ –¥–µ–Ω—å–≥–∏ üí∞"

   –ö–ª–∏–µ–Ω—Ç: "–ü–æ—Å–æ–≤–µ—Ç—É—é—Å—å —Å –º—É–∂–µ–º/–∂–µ–Ω–æ–π"
   –ë–æ—Ç: "–ö–æ–Ω–µ—á–Ω–æ, —Å–µ–º–µ–π–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ! üòä

   –ü–æ–∫–∞ –≤—ã —Å–æ–≤–µ—Ç—É–µ—Ç–µ—Å—å, –æ—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω - –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏ –∏ –ø—Ä–∏—à–ª—ë—Ç –≤–∞–º. –¢–∞–∫ –±—É–¥–µ—Ç —É–¥–æ–±–Ω–µ–µ –æ–±—Å—É–∂–¥–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è ‚ú®"

   –í–ê–ñ–ù–û:
   - –ù–ï –±—ã—Ç—å –Ω–∞–≤—è–∑—á–∏–≤—ã–º
   - –ù–ï –¥–∞–≤–∏—Ç—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
   - –°–æ–∑–¥–∞–≤–∞—Ç—å –ª—ë–≥–∫—É—é —Å—Ä–æ—á–Ω–æ—Å—Ç—å (—Ü–µ–Ω—ã, —Å–µ–∑–æ–Ω, –º–µ—Å—Ç–∞)
   - –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω

5. **–°–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:**
   –ü—Ä–æ—Å–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Ç–µ–ª—å!

   –ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –¥–∞–ª —Ç–µ–ª–µ—Ñ–æ–Ω, –ø—Ä–æ—Å—Ç–æ –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏:
   "–°–ø–∞—Å–∏–±–æ! –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞ ‚ú®"

5. **–°–æ–≤–µ—Ç—ã:**
   "–í–æ–∑—å–º–∏—Ç–µ –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Ä–æ–∑–µ—Ç–æ–∫ üîå"
   "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –º–µ—Å—Ç–Ω—É—é –∫—É—Ö–Ω—é üçΩÔ∏è"

–ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏: üå¥ ‚úàÔ∏è üèñÔ∏è üòä üëç ‚≠ê üè® üí∞
–ù–û –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π ** –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è!`;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI —Å —É—á–µ—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
   */
  async getChatResponse(userMessage, userData, conversationHistory = []) {
    try {
      const systemPrompt = this.generateSystemPrompt(userData);

      const messages = [
        { role: 'system', content: systemPrompt },
        ...conversationHistory,
        { role: 'user', content: userMessage }
      ];

      // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ OpenAI —Å tools
      let response = await this.openai.chat.completions.create({
        model: this.model,
        messages: messages,
        temperature: 0.3,  // –°–Ω–∏–∂–µ–Ω–æ —Å 0.7 –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π
        max_tokens: 1000,
        tools: TOOLS,
        tool_choice: 'auto'  // AI —Å–∞–º —Ä–µ—à–∞–µ—Ç –∫–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏
      });

      let assistantMessage = response.choices[0].message;

      // –ï—Å–ª–∏ AI —Ö–æ—á–µ—Ç –≤—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é
      if (assistantMessage.tool_calls && assistantMessage.tool_calls.length > 0) {
        messages.push(assistantMessage);  // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ AI —Å tool_calls

        console.log(`üîß AI –≤—ã–∑—ã–≤–∞–µ—Ç ${assistantMessage.tool_calls.length} —Ñ—É–Ω–∫—Ü–∏–π`);

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π tool call
        for (const toolCall of assistantMessage.tool_calls) {
          const functionName = toolCall.function.name;
          const functionArgs = JSON.parse(toolCall.function.arguments);

          console.log(`  ‚Üí ${functionName}:`, functionArgs);

          let functionResult;
          try {
            // –í—ã–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
            if (functionName === 'search_flights') {
              // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤ –≤ IATA –∫–æ–¥—ã
              const originCode = aviasalesApi.getCityCode(functionArgs.origin);
              const destCode = aviasalesApi.getCityCode(functionArgs.destination);

              if (!originCode || !destCode) {
                functionResult = {
                  error: '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∫–æ–¥—ã –∞—ç—Ä–æ–ø–æ—Ä—Ç–æ–≤ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤',
                  origin: functionArgs.origin,
                  destination: functionArgs.destination
                };
              } else {
                const flights = await aviasalesApi.searchFlights({
                  origin: originCode,
                  destination: destCode,
                  departureDate: functionArgs.departure_date,
                  returnDate: functionArgs.return_date,
                  adults: functionArgs.adults
                });

                functionResult = flights || {
                  error: '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∞–≤–∏–∞–±–∏–ª–µ—Ç—ã. API –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.',
                  fallback: 'use_approximate_prices'
                };
              }
            } else if (functionName === 'search_hotels') {
              const hotels = await hotellookApi.searchHotels({
                location: functionArgs.location,
                checkIn: functionArgs.check_in,
                checkOut: functionArgs.check_out,
                adults: functionArgs.adults,
                stars: functionArgs.stars
              });

              if (hotels && hotels.length > 0 && hotels[0].name !== `–û—Ç–µ–ª—å ${functionArgs.stars || 5}‚≠ê`) {
                // API —É—Å–ø–µ—à–Ω–æ –≤–µ—Ä–Ω—É–ª —Ä–µ–∞–ª—å–Ω—ã–µ –æ—Ç–µ–ª–∏ (–Ω–µ fallback)
                functionResult = {
                  success: true,
                  hotels: hotels,
                  message: '–ù–∞–π–¥–µ–Ω—ã —Ä–µ–∞–ª—å–Ω—ã–µ –æ—Ç–µ–ª–∏'
                };
              } else {
                // API –≤–µ—Ä–Ω—É–ª fallback –∏–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤–µ—Ä–Ω—É–ª
                functionResult = {
                  success: false,
                  error: '–ü–æ–∏—Å–∫ –æ—Ç–µ–ª–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω',
                  instruction: '–î–∞–π –¢–û–õ–¨–ö–û –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Ü–µ–Ω—ã –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –æ—Ç–µ–ª–µ–π. –ù–ï –Ω–∞–∑—ã–≤–∞–π Rixos, Hilton, Kurumba –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—Ç–µ–ª–∏.'
                };
              }
            }
          } catch (error) {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è ${functionName}:`, error.message);
            functionResult = {
              error: error.message,
              fallback: 'use_approximate_prices'
            };
          }

          console.log(`  ‚úì –†–µ–∑—É–ª—å—Ç–∞—Ç ${functionName}:`, functionResult ? 'OK' : 'null');

          // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é
          messages.push({
            role: 'tool',
            tool_call_id: toolCall.id,
            content: JSON.stringify(functionResult)
          });
        }

        // –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –∫ OpenAI —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ñ—É–Ω–∫—Ü–∏–π
        response = await this.openai.chat.completions.create({
          model: this.model,
          messages: messages,
          temperature: 0.3
        });

        assistantMessage = response.choices[0].message;
      }

      return assistantMessage.content;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenAI:', error.message);
      throw error;
    }
  }

  /**
   * –°—É–º–º–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
   */
  async summarizeConversation(conversationHistory) {
    try {
      if (!conversationHistory || conversationHistory.length === 0) {
        return '–ö–ª–∏–µ–Ω—Ç –æ—Å—Ç–∞–≤–∏–ª —Ç–µ–ª–µ—Ñ–æ–Ω';
      }

      // –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏
      const userMessages = conversationHistory
        .filter(msg => msg.role === 'user')
        .map(msg => msg.content)
        .join('\n');

      const summaryPrompt = `–ü—Ä–æ—á–∏—Ç–∞–π –¥–∏–∞–ª–æ–≥ —Å –∫–ª–∏–µ–Ω—Ç–æ–º —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –∏ —Å–æ–∑–¥–∞–π –∫—Ä–∞—Ç–∫—É—é –≤—ã–∂–∏–º–∫—É (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞.

–£–∫–∞–∂–∏ —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ:
- –ö—É–¥–∞ —Ö–æ—á–µ—Ç –ø–æ–µ—Ö–∞—Ç—å
- –ö–æ–≥–¥–∞ (–¥–∞—Ç—ã)
- –°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫
- –ö–∞–∫–æ–π –æ—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª (–µ—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–ª)
- –ë—é–¥–∂–µ—Ç (–µ—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–ª)

–°–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞:
${userMessages}

–í—ã–∂–∏–º–∫–∞ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è):`;

      const response = await this.openai.chat.completions.create({
        model: this.model,
        messages: [
          { role: 'user', content: summaryPrompt }
        ],
        temperature: 0.3,
        max_tokens: 200
      });

      return response.choices[0].message.content.trim();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –¥–∏–∞–ª–æ–≥–∞:', error.message);
      // Fallback: –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const recentMessages = conversationHistory
        .filter(msg => msg.role === 'user')
        .slice(-3)
        .map(msg => msg.content)
        .join('. ')
        .substring(0, 200);

      return recentMessages || '–ö–ª–∏–µ–Ω—Ç –æ—Å—Ç–∞–≤–∏–ª —Ç–µ–ª–µ—Ñ–æ–Ω';
    }
  }
}

export default new AIService();
