import OpenAI from 'openai';
import { config } from '../config/config.js';
import tavilyService from './tavilyService.js';
import pineconeService from './pineconeService.js';

class AIService {
  constructor() {
    this.openai = new OpenAI({
      apiKey: config.openai.apiKey
    });
    this.model = config.openai.model;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è OpenAI Function Calling
    this.tools = [
      {
        type: 'function',
        function: {
          name: 'search_general_info',
          description: '–ü–æ–∏—Å–∫ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ —á–µ—Ä–µ–∑ Tavily AI. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ —É–∑–Ω–∞—Ç—å –ø—Ä–æ –≤–∏–∑—ã, –∫–ª–∏–º–∞—Ç, –ø–æ–≥–æ–¥—É, –æ—Ç–∑—ã–≤—ã, –Ω–æ–≤–æ—Å—Ç–∏ –æ —Å—Ç—Ä–∞–Ω–µ, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ä–µ–∑–¥–∞.',
          parameters: {
            type: 'object',
            properties: {
              query: {
                type: 'string',
                description: '–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–Ω—É–∂–Ω–∞ –ª–∏ –≤–∏–∑–∞ –≤ –¢—É—Ä—Ü–∏—é 2026", "–ø–æ–≥–æ–¥–∞ –≤ –î—É–±–∞–µ –≤ –º–∞—Ä—Ç–µ", "–æ—Ç–∑—ã–≤—ã —Ç—É—Ä–∏—Å—Ç–æ–≤ –æ –ü—Ö—É–∫–µ—Ç–µ")'
              }
            },
            required: ['query']
          }
        }
      },
      {
        type: 'function',
        function: {
          name: 'search_company_info',
          description: '–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–µ "–ü–ª–∞–Ω–µ—Ç–∞" (–ü–µ—Ä–º—å). –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –∫–æ–º–ø–∞–Ω–∏–∏, —É—Å–ª—É–≥–∞—Ö, –æ—Ñ–∏—Å–∞—Ö, –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö, —Ä–∞—Å—Å—Ä–æ—á–∫–µ/–∫—Ä–µ–¥–∏—Ç–µ, –æ—Ç–∑—ã–≤–∞—Ö, –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö –∏–∑ –ü–µ—Ä–º–∏, FAQ. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –æ–±—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—Ä–∞–Ω–∞—Ö.',
          parameters: {
            type: 'object',
            properties: {
              query: {
                type: 'string',
                description: '–í–æ–ø—Ä–æ—Å –æ —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–µ "–ü–ª–∞–Ω–µ—Ç–∞" (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–∫–∞–∫–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑ –ü–µ—Ä–º–∏", "–∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å —Ä–∞—Å—Å—Ä–æ—á–∫—É", "–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –æ—Ñ–∏—Å", "–∫–∞–∫–∏–µ –æ—Ç–∑—ã–≤—ã –æ –∫–æ–º–ø–∞–Ω–∏–∏")'
              }
            },
            required: ['query']
          }
        }
      }
    ];
  }

  /**
   * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è AI –∞–≥–µ–Ω—Ç–∞ (v2.0 ‚Äî –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ª–∏–¥–æ–≤)
   */
  generateSystemPrompt(userData) {
    const now = new Date();
    const currentDate = now.toLocaleString('ru-RU', {
      day: '2-digit',
      month: 'long',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    return `–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: ${currentDate}.
ID –∫–ª–∏–µ–Ω—Ç–∞: ${userData.peerId}.
–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞: ${userData.firstName}.
–°–∞–π—Ç –∫–æ–º–ø–∞–Ω–∏–∏: planetaperm.ru

–í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–∞—Ç –ø–æ–µ–∑–¥–æ–∫. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç "—á–µ—Ä–µ–∑ –º–µ—Å—è—Ü" ‚Äî —Å—á–∏—Ç–∞–π –æ—Ç —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã.

–¢—ã ‚Äî –ö–∞—Ç—è, –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ "–ü–ª–∞–Ω–µ—Ç–∞" (–≥. –ü–µ—Ä–º—å). –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Ç–µ–ø–ª–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –ø–æ–æ–±—â–∞—Ç—å—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º, —Å–æ–±—Ä–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –µ–≥–æ –ø–æ–∂–µ–ª–∞–Ω–∏—è—Ö, –¥–∞—Ç—å –ø—Ä–∏–º–µ—Ä–Ω—É—é –æ—Ü–µ–Ω–∫—É —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –ø–µ—Ä–µ–¥–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É –≥–æ—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–º.

–¢–û–ù–ê–õ–¨–ù–û–°–¢–¨ –ò –°–¢–ò–õ–¨:
- –ñ–∏–≤–æ–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω ‚Äî –∫–∞–∫ –æ–ø—ã—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ —Ç—É—Ä–∏–∑–º—É
- –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ —ç–º–æ–¥–∑–∏ (2-3 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ), —á–µ—Ä–µ–¥—É–π –∏—Ö!
- –ü–∞–ª–∏—Ç—Ä–∞: ‚úàÔ∏è üå¥ üè® üí∞ üìû ‚ú® üåä ‚≠ê üéØ üèñÔ∏è üåÖ üó∫Ô∏è üë®‚Äçüë©‚Äçüëß üíé ‚òÄÔ∏è üéâ üëå üí´ üôå ü§ù üå∫ üèùÔ∏è ‚õ±Ô∏è üß≥ üéä üí¨ üôè üòä ü§© üòâ üëã ü´∂ üî• ü•∞
- –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–∏–Ω —ç–º–æ–¥–∑–∏ 2 —Ä–∞–∑–∞ –ø–æ–¥—Ä—è–¥ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏!
- –ë–ï–ó —Å–ª–µ–Ω–≥–∞ —Ç–∏–ø–∞ "–æ–≥–æ–Ω—å", "–±–æ–º–±–∞", "–ø—É—à–∫–∞", "–∫–∞–π—Ñ"
- –ü–∏—à–∏ –≥—Ä–∞–º–æ—Ç–Ω–æ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π ** –∏–ª–∏ * –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞

–ü–ï–†–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ):
"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${userData.firstName}! üëã –ú–µ–Ω—è –∑–æ–≤—É—Ç –ö–∞—Ç—è, —è –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ ¬´–ü–ª–∞–Ω–µ—Ç–∞¬ª.

–Ø –ø–æ–º–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ç—É—Ä, –æ—Ç–≤–µ—á—É –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö –∏ —Ä–∞—Å—Å–∫–∞–∂—É –æ –Ω–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ ‚úàÔ∏è –ö–∞–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç? üåç"

–ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–¨ –°–ë–û–†–ê –ò–ù–§–û–†–ú–ê–¶–ò–ò (–∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –ü–û –û–î–ù–û–ú–£, –Ω–µ –≤—Å–µ —Å—Ä–∞–∑—É!):

1Ô∏è‚É£ –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï: "–ö–∞–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?" üåç
   –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è ‚Äî –ø–æ–¥—Å–∫–∞–∂–∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ: –¢—É—Ä—Ü–∏—è, –û–ê–≠, –ï–≥–∏–ø–µ—Ç, –¢–∞–∏–ª–∞–Ω–¥, –ú–∞–ª—å–¥–∏–≤—ã, –®—Ä–∏-–õ–∞–Ω–∫–∞, –ö—É–±–∞, –í—å–µ—Ç–Ω–∞–º, –†–æ—Å—Å–∏—è

2Ô∏è‚É£ –ü–†–ï–î–ü–û–ß–¢–ï–ù–ò–Ø –ü–û –û–¢–î–´–•–£: "–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –æ—Ç–¥—ã—Ö—É? üèñÔ∏è (–∑–≤—ë–∑–¥–Ω–æ—Å—Ç—å –æ—Ç–µ–ª—è, all inclusive, SPA, –±–ª–∏–∑–æ—Å—Ç—å –∫ –º–æ—Ä—é, –¥–µ—Ç—Å–∫–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –∏ —Ç.–¥.)"
   –ù–ï –ø–µ—Ä–µ—á–∏—Å–ª—è–π –¥–ª–∏–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫, –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –ö–û–†–û–¢–ö–û ‚Äî –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –≤ —Å–∫–æ–±–∫–∞—Ö.
   –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å—Ä–∞–∑—É –Ω–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ ‚Äî –Ω–µ –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–π, –∑–∞–ø–æ–º–Ω–∏ –∏ –¥–≤–∏–≥–∞–π—Å—è –¥–∞–ª—å—à–µ.

3Ô∏è‚É£ –î–ê–¢–´: "–ö–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–µ–∑–¥–∫—É? –ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π?" üìÖ
   (–µ—Å–ª–∏ "—á–µ—Ä–µ–∑ –º–µ—Å—è—Ü" –∏–ª–∏ "–≤ –º–∞—Ä—Ç–µ" ‚Äî —Ä–∞—Å—Å—á–∏—Ç–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã)

4Ô∏è‚É£ –ö–û–õ–ò–ß–ï–°–¢–í–û –ß–ï–õ–û–í–ï–ö: "–°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–æ–µ–¥–µ—Ç?" üë®‚Äçüë©‚Äçüëß
   –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞—é—Ç—Å—è –¥–µ—Ç–∏ ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É—Ç–æ—á–Ω–∏ –≤–æ–∑—Ä–∞—Å—Ç –∫–∞–∂–¥–æ–≥–æ —Ä–µ–±—ë–Ω–∫–∞:
   "–°–∫–æ–ª—å–∫–æ –ª–µ—Ç —Ä–µ–±—ë–Ω–∫—É/–¥–µ—Ç—è–º? –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ —Ç—É—Ä–∞ üß∏"

5Ô∏è‚É£ –ë–Æ–î–ñ–ï–¢: "–ù–∞ –∫–∞–∫–æ–π –±—é–¥–∂–µ—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–µ—Ç–µ—Å—å? üí∞"
   (–±—é–¥–∂–µ—Ç –ù–ê –í–°–Æ –ü–û–ï–ó–î–ö–£: –ø–µ—Ä–µ–ª—ë—Ç + –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ + –≤—Å—ë –≤–∫–ª—é—á–µ–Ω–æ)

6Ô∏è‚É£ –ì–û–†–û–î –í–´–õ–ï–¢–ê: "–ò–∑ –∫–∞–∫–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –≤—ã–ª–µ—Ç?" ‚úàÔ∏è
   –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∏–∑ –ü–µ—Ä–º–∏ ‚Äî –æ—Ç–º–µ—Ç—å —ç—Ç–æ, –µ—Å–ª–∏ –∏–∑ –¥—Ä—É–≥–æ–≥–æ –≥–æ—Ä–æ–¥–∞ ‚Äî –∑–∞–ø–æ–º–Ω–∏ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞.

–û–¶–ï–ù–ö–ê –ë–Æ–î–ñ–ï–¢–ê –ò –†–ï–ê–õ–ò–°–¢–ò–ß–ù–û–°–¢–¨:
–ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –Ω–∞–∑–≤–∞–ª –±—é–¥–∂–µ—Ç –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Äî –æ—Ü–µ–Ω–∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å!
- –ï—Å–ª–∏ –±—é–¥–∂–µ—Ç –°–õ–ò–®–ö–û–ú –º–∞–ª–µ–Ω—å–∫–∏–π –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú–∞–ª—å–¥–∏–≤—ã –∑–∞ 100 000‚ÇΩ –Ω–∞ –¥–≤–æ–∏—Ö) ‚Äî –ú–Ø–ì–ö–û –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏: "–î–ª—è –ú–∞–ª—å–¥–∏–≤ –±—é–¥–∂–µ—Ç –≤ 100 000‚ÇΩ –Ω–∞ –¥–≤–æ–∏—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –º–∞–ª–æ–≤–∞—Ç ‚Äî –æ–±—ã—á–Ω–æ —Ç—É—Ä—ã —Ç—É–¥–∞ —Å—Ç–∞—Ä—Ç—É—é—Ç –æ—Ç 250-300 —Ç—ã—Å—è—á ‚úàÔ∏è –ú–æ–∂–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –±–ª–∏–∂–µ –∫ –±—é–¥–∂–µ—Ç—É, –Ω–∞–ø—Ä–∏–º–µ—Ä –¢—É—Ä—Ü–∏—é –∏–ª–∏ –ï–≥–∏–ø–µ—Ç?"
- –ï—Å–ª–∏ –±—é–¥–∂–µ—Ç —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–¥–∏: "–û—Ç–ª–∏—á–Ω—ã–π –±—é–¥–∂–µ—Ç –¥–ª—è —ç—Ç–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è! üëå"

–ü–û–°–õ–ï –°–ë–û–†–ê –í–°–ï–ô –ò–ù–§–û–†–ú–ê–¶–ò–ò:

1. –ü–æ–¥–±–µ—Ä–∏ 2-3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –æ—Ç–µ–ª—è, –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø–æ–¥ –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–π —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –æ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –æ—Ç–µ–ª—è—Ö –∏–ª–∏ search_general_info)
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Ç–µ–ª—è —É–∫–∞–∂–∏: –Ω–∞–∑–≤–∞–Ω–∏–µ, –∑–≤—ë–∑–¥–Ω–æ—Å—Ç—å, –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (1 —Å—Ç—Ä–æ–∫–∞) –∏ –ü–†–ò–ú–ï–†–ù–£–Æ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥
3. –£–∫–∞–∂–∏ –ø—Ä–∏–º–µ—Ä–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–ª—ë—Ç–∞
4. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–±–∞–≤—å –¥–∏—Å–∫–ª–µ–π–º–µ—Ä ‚Äî —Ü–µ–Ω—ã –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–µ, —Ç—ã –º–æ–∂–µ—à—å –æ—à–∏–±–∞—Ç—å—Å—è, —Ç–æ—á–Ω—ã–µ —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä –∏–ª–∏ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Å–∞–π—Ç–µ planetaperm.ru

–ü—Ä–∏–º–µ—Ä:
"–û—Ç–ª–∏—á–Ω–æ! –í–æ—Ç —á—Ç–æ –º–æ–≥—É –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É üìã

‚úàÔ∏è –ü–µ—Ä–µ–ª—ë—Ç –∏–∑ –ü–µ—Ä–º–∏ (—Å –ø–µ—Ä–µ—Å–∞–¥–∫–æ–π): ~50-70 —Ç—ã—Å. –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞

üè® Rixos Premium Bodrum 5‚≠ê
–†–æ—Å–∫–æ—à–Ω—ã–π –æ—Ç–µ–ª—å, all inclusive, –ø–µ—Ä–≤–∞—è –ª–∏–Ω–∏—è, –æ—Ç–ª–∏—á–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
–ü—Ä–∏–º–µ—Ä–Ω–æ: 250-300 —Ç—ã—Å. –∑–∞ –Ω–æ–º–µ—Ä (7 –Ω–æ—á–µ–π)

üè® Voyage Bodrum 5‚≠ê
–°–µ–º–µ–π–Ω—ã–π –æ—Ç–µ–ª—å, ultra all inclusive, –∞–∫–≤–∞–ø–∞—Ä–∫, —É –º–æ—Ä—è
–ü—Ä–∏–º–µ—Ä–Ω–æ: 200-250 —Ç—ã—Å. –∑–∞ –Ω–æ–º–µ—Ä (7 –Ω–æ—á–µ–π)

üè® Kefaluka Resort 5‚≠ê
–ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π –æ—Ç–µ–ª—å —Å –±–æ–ª—å—à–æ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–µ–π –∏ –¥–µ—Ç—Å–∫–∏–º –∫–ª—É–±–æ–º
–ü—Ä–∏–º–µ—Ä–Ω–æ: 170-220 —Ç—ã—Å. –∑–∞ –Ω–æ–º–µ—Ä (7 –Ω–æ—á–µ–π)

–ò—Ç–æ–≥–æ –Ω–∞ –≤—Å–µ—Ö –ø—Ä–∏–º–µ—Ä–Ω–æ: 350-500 —Ç—ã—Å. –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ç–µ–ª—è üí∞

‚ö†Ô∏è –≠—Ç–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–µ —Ü–µ–Ω—ã, —Ç–æ—á–Ω—ã–µ —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä, –∏–ª–∏ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞ –Ω–∞—à–µ–º —Å–∞–π—Ç–µ planetaperm.ru, –ø–æ—Ç–æ–º—É —á—Ç–æ —è –º–æ–≥–ª–∞ –æ—à–∏–±–∏—Ç—å—Å—è –∫–∞–∫ –≤ –º–µ–Ω—å—à—É—é —Å—Ç–æ—Ä–æ–Ω—É —Ç–∞–∫ –∏ –≤ –±–æ–ª—å—à—É—é.

–û—Å—Ç–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∏ –ø–æ–¥—Å–∫–∞–∂–∏—Ç–µ –∫–∞–∫ —É–¥–æ–±–Ω–µ–µ —Å–≤—è–∑–∞—Ç—å—Å—è ‚Äî –∑–≤–æ–Ω–æ–∫, Telegram, WhatsApp –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏–º –∑–¥–µ—Å—å –≤ –í–ö? üìû"

–ü–û–°–õ–ï –ü–û–õ–£–ß–ï–ù–ò–Ø –¢–ï–õ–ï–§–û–ù–ê –ò –°–ü–û–°–û–ë–ê –°–í–Ø–ó–ò:
"–°–ø–∞—Å–∏–±–æ, ${userData.firstName}! üôè –ü–µ—Ä–µ–¥–∞—é –≤–∞—à –∑–∞–ø—Ä–æ—Å –º–µ–Ω–µ–¥–∂–µ—Ä—É. –û–Ω —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ [—Å–ø–æ—Å–æ–±–æ–º —Å–≤—è–∑–∏] –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –∏ –ø–æ–¥–±–µ—Ä—ë—Ç –ª—É—á—à–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã! ‚ú®

–ï—Å–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –µ—â—ë –≤–æ–ø—Ä–æ—Å—ã ‚Äî –ø–∏—à–∏—Ç–µ, –≤—Å–µ–≥–¥–∞ —Ä–∞–¥–∞ –ø–æ–º–æ—á—å üòä"

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í:

–£ —Ç–µ–±—è –µ—Å—Ç—å 2 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:

A) search_general_info ‚Äî –ø–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Tavily AI
   –í—ã–∑—ã–≤–∞–π –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ –≤–∏–∑—ã, –ø–æ–≥–æ–¥—É, –æ—Ç–∑—ã–≤—ã, –∫–ª–∏–º–∞—Ç, –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
   –¢–∞–∫–∂–µ –º–æ–∂–µ—à—å –≤—ã–∑–≤–∞—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω –Ω–∞ –ø–µ—Ä–µ–ª—ë—Ç—ã/–æ—Ç–µ–ª–∏ –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å–≤–æ–¥–∫–∏.

B) search_company_info ‚Äî –ø–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–µ "–ü–ª–∞–Ω–µ—Ç–∞"
   –í—ã–∑—ã–≤–∞–π –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Å–∞–º–æ–π –∫–æ–º–ø–∞–Ω–∏–∏, –µ—ë —É—Å–ª—É–≥–∞—Ö, –æ—Ñ–∏—Å–∞—Ö, –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö, —Ä–∞—Å—Å—Ä–æ—á–∫–µ/–∫—Ä–µ–¥–∏—Ç–µ, –æ—Ç–∑—ã–≤–∞—Ö, –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö –∏–∑ –ü–µ—Ä–º–∏, FAQ, —Ä–∞–±–æ—Ç–Ω–∏–∫–∞—Ö, –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞—Ö, –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö –∫–æ–º–ø–∞–Ω–∏–∏/–º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤.
   –ü—Ä–∏–º–µ—Ä—ã: "–≥–¥–µ –≤–∞—à –æ—Ñ–∏—Å?", "–º–æ–∂–Ω–æ –ª–∏ –≤ —Ä–∞—Å—Å—Ä–æ—á–∫—É?", "–∫–∞–∫–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –µ—Å—Ç—å?", "—Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –∫–æ–º–ø–∞–Ω–∏–∏"

–û–ë–†–ê–ë–û–¢–ö–ê –í–û–ó–†–ê–ñ–ï–ù–ò–ô:

"–î–æ—Ä–æ–≥–æ" ‚Üí "–ü–æ–Ω–∏–º–∞—é! –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥–±–µ—Ä—ë—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–¥ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π –±—é–¥–∂–µ—Ç. –ö–∞–∫–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ? üí´"

"–ü–æ–¥—É–º–∞—é" ‚Üí "–ö–æ–Ω–µ—á–Ω–æ, –Ω–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ—Å—å! ü§ù –ï—Å–ª–∏ —á—Ç–æ ‚Äî –ø–∏—à–∏—Ç–µ, –≤—Å–µ–≥–¥–∞ —Ä–∞–¥–∞ –ø–æ–º–æ—á—å. –£—á—Ç–∏—Ç–µ —á—Ç–æ –≤ —Å–µ–∑–æ–Ω —Ü–µ–Ω—ã —Ä–∞—Å—Ç—É—Ç –±—ã—Å—Ç—Ä–æ"

"–°–∞–º –∑–∞–±—Ä–æ–Ω–∏—Ä—É—é" ‚Üí "–ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —á–∞—Å—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–µ—à–µ–≤–ª–µ —á–µ–º –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö, –ø–ª—é—Å –ø–æ–º–æ–∂–µ—Ç —Å–æ –≤—Å–µ–º–∏ –Ω—é–∞–Ω—Å–∞–º–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è üëå –ó–∞–≥–ª—è–Ω–∏—Ç–µ –Ω–∞ –Ω–∞—à —Å–∞–π—Ç planetaperm.ru"

"–ù–µ —Ö–æ—á—É –æ—Å—Ç–∞–≤–ª—è—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω" ‚Üí "–ë–µ–∑ –ø—Ä–æ–±–ª–µ–º! –ú–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É –ø—Ä—è–º–æ –∑–¥–µ—Å—å –≤ –í–ö, –∏–ª–∏ —è –ø–µ—Ä–µ–¥–∞–º –≤–∞—à –∑–∞–ø—Ä–æ—Å –∏ –º–µ–Ω–µ–¥–∂–µ—Ä —Å–∞–º –Ω–∞–ø–∏—à–µ—Ç –≤–∞–º –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è üì©"

–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê:
- –û–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –∑–∞ —Ä–∞–∑! –ù–µ –∑–∞–¥–∞–≤–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
- –ï—Å–ª–∏ –¥–µ—Ç–∏ ‚Äî —Å–ø—Ä–æ—Å–∏ –≤–æ–∑—Ä–∞—Å—Ç!
- –ù–ò–ö–û–ì–î–ê –Ω–µ –æ–±—Å—É–∂–¥–∞–π –∫–æ–º–∏—Å—Å–∏—é, –Ω–∞—Ü–µ–Ω–∫—É, —Ü–µ–Ω—É –∑–∞–∫—É–ø–∫–∏
- –ù–ò–ö–û–ì–î–ê –Ω–µ –¥–∞–≤–∞–π –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ Booking.com –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Å–∞–π—Ç—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- –î–ª—è –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–Ω ‚Äî –í–°–ï–ì–î–ê –≤ –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤–ª—è–π –æ–≥–æ–≤–æ—Ä–∫—É —Å ‚ö†Ô∏è —á—Ç–æ —Ü–µ–Ω—ã –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–µ, —Ç—ã –º–æ–≥–ª–∞ –æ—à–∏–±–∏—Ç—å—Å—è –∫–∞–∫ –≤ –º–µ–Ω—å—à—É—é —Ç–∞–∫ –∏ –≤ –±–æ–ª—å—à—É—é —Å—Ç–æ—Ä–æ–Ω—É, —Ç–æ—á–Ω—ã–µ —Ü–µ–Ω—ã —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏–ª–∏ –Ω–∞ —Å–∞–π—Ç–µ planetaperm.ru
- –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ —Ü–µ–Ω–∞—Ö ‚Äî —Ç–∞–∫ –∏ —Å–∫–∞–∂–∏, –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —á–∏—Å–µ–ª
- –¢–µ–ª–µ—Ñ–æ–Ω –∏ —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏ –ø—Ä–æ—Å–∏ –ü–û–°–õ–ï —Å–≤–æ–¥–∫–∏ —Å –ø—Ä–∏–º–µ—Ä–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏
- –ü—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ —Å–∞–π—Ç–∞ ‚Äî –≥–æ–≤–æ—Ä–∏ planetaperm.ru`;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Function Calling
   */
  async getChatResponse(userMessage, userData, conversationHistory = []) {
    try {
      const systemPrompt = this.generateSystemPrompt(userData);

      const messages = [
        { role: 'system', content: systemPrompt },
        ...conversationHistory,
        { role: 'user', content: userMessage }
      ];

      // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ OpenAI —Å tools
      const response = await this.openai.chat.completions.create({
        model: this.model,
        messages: messages,
        tools: this.tools,
        tool_choice: 'auto',
        temperature: 0.7,
        max_tokens: 1500
      });

      const assistantMessage = response.choices[0].message;

      // –ï—Å–ª–∏ AI –Ω–µ –≤—ã–∑–≤–∞–ª —Ñ—É–Ω–∫—Ü–∏–∏ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç
      if (!assistantMessage.tool_calls) {
        return assistantMessage.content;
      }

      // –ï—Å–ª–∏ AI –≤—ã–∑–≤–∞–ª —Ñ—É–Ω–∫—Ü–∏–∏ ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Ö
      console.log('ü§ñ AI –≤—ã–∑–≤–∞–ª —Ñ—É–Ω–∫—Ü–∏–∏:', assistantMessage.tool_calls.map(tc => tc.function.name).join(', '));

      // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —Å –≤—ã–∑–æ–≤–æ–º —Ñ—É–Ω–∫—Ü–∏–π –≤ –∏—Å—Ç–æ—Ä–∏—é
      messages.push(assistantMessage);

      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏
      for (const toolCall of assistantMessage.tool_calls) {
        const functionName = toolCall.function.name;
        const functionArgs = JSON.parse(toolCall.function.arguments);

        console.log(`üîß –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏: ${functionName}`, functionArgs);

        let functionResult;

        if (functionName === 'search_general_info') {
          functionResult = await this.performGeneralSearch(functionArgs.query);
        } else if (functionName === 'search_company_info') {
          functionResult = await this.performCompanySearch(functionArgs.query);
        } else {
          functionResult = { error: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è' };
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é
        messages.push({
          role: 'tool',
          tool_call_id: toolCall.id,
          content: JSON.stringify(functionResult)
        });
      }

      // –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –∫ OpenAI —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ñ—É–Ω–∫—Ü–∏–π
      const secondResponse = await this.openai.chat.completions.create({
        model: this.model,
        messages: messages,
        temperature: 0.7,
        max_tokens: 1500
      });

      return secondResponse.choices[0].message.content;

    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenAI:', error.message);
      throw error;
    }
  }

  /**
   * –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Tavily AI
   */
  async performGeneralSearch(query) {
    try {
      console.log(`üåê –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: "${query}"`);

      const result = await tavilyService.searchInfo(query);

      if (!result) {
        return {
          success: false,
          message: '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∑–∞–ø—Ä–æ—Å—É.'
        };
      }

      return {
        success: true,
        info: result
      };

    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:', error.message);
      return {
        success: false,
        message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.'
      };
    }
  }

  /**
   * –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–ø–∞–Ω–∏–∏ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π (Pinecone)
   */
  async performCompanySearch(query) {
    try {
      console.log(`üìö –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π: "${query}"`);

      const result = await pineconeService.searchKnowledgeBase(query, 5);

      if (!result) {
        return {
          success: false,
          message: '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –∫–æ–º–ø–∞–Ω–∏–∏.'
        };
      }

      return {
        success: true,
        info: result
      };

    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π:', error.message);
      return {
        success: false,
        message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–ø–∞–Ω–∏–∏.'
      };
    }
  }

  /**
   * –°—É–º–º–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)
   */
  async summarizeConversation(conversationHistory) {
    try {
      if (!conversationHistory || conversationHistory.length === 0) {
        return { details: '–ö–ª–∏–µ–Ω—Ç –æ—Å—Ç–∞–≤–∏–ª —Ç–µ–ª–µ—Ñ–æ–Ω' };
      }

      const allMessages = conversationHistory
        .filter(msg => msg.role === 'user' || msg.role === 'assistant')
        .map(msg => `${msg.role === 'user' ? '–ö–ª–∏–µ–Ω—Ç' : '–ë–æ—Ç'}: ${msg.content}`)
        .join('\n');

      const summaryPrompt = `–ü—Ä–æ—á–∏—Ç–∞–π –¥–∏–∞–ª–æ–≥ —Å –∫–ª–∏–µ–Ω—Ç–æ–º —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –∏ –∏–∑–≤–ª–µ–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON (–±–µ–∑ markdown, –±–µ–∑ \`\`\`) –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
{
  "destination": "–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏ (—Å—Ç—Ä–∞–Ω–∞, –≥–æ—Ä–æ–¥/–∫—É—Ä–æ—Ä—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä: '–ë—Ä–∞–∑–∏–ª–∏—è, –†–∏–æ-–¥–µ-–ñ–∞–Ω–µ–π—Ä–æ') –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ",
  "dates": "–¥–∞—Ç—ã –ø–æ–µ–∑–¥–∫–∏ –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: '5-12 —Ñ–µ–≤—Ä–∞–ª—è 2027 (7 –¥–Ω–µ–π)') –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ",
  "preferences": "–ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –æ—Ç–¥—ã—Ö—É (all inclusive, SPA, –ø–µ—Ä–≤–∞—è –ª–∏–Ω–∏—è –∏ —Ç.–¥.) –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ",
  "people": "—Å–æ—Å—Ç–∞–≤ –≥—Ä—É–ø–ø—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: '2 –≤–∑—Ä–æ—Å–ª—ã—Ö + 1 —Ä–µ–±—ë–Ω–æ–∫ 5 –ª–µ—Ç') –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ",
  "budget": "–±—é–¥–∂–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: '~500 000‚ÇΩ') –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ",
  "departureCity": "–≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–ü–µ—Ä–º—å') –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ",
  "details": "–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ 4-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ ‚Äî —á—Ç–æ —Ö–æ—á–µ—Ç –∫–ª–∏–µ–Ω—Ç, –æ—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è, –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞"
}

–î–∏–∞–ª–æ–≥:
${allMessages}

JSON:`;

      const response = await this.openai.chat.completions.create({
        model: this.model,
        messages: [
          { role: 'user', content: summaryPrompt }
        ],
        temperature: 0.3,
        max_tokens: 500
      });

      const raw = response.choices[0].message.content.trim();

      // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON
      try {
        const parsed = JSON.parse(raw);
        return {
          destination: parsed.destination || null,
          dates: parsed.dates || null,
          preferences: parsed.preferences || null,
          people: parsed.people || null,
          budget: parsed.budget || null,
          departureCity: parsed.departureCity || null,
          details: parsed.details || '–ö–ª–∏–µ–Ω—Ç –æ—Å—Ç–∞–≤–∏–ª —Ç–µ–ª–µ—Ñ–æ–Ω'
        };
      } catch {
        // –ï—Å–ª–∏ GPT –≤–µ—Ä–Ω—É–ª –Ω–µ JSON ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
        return { details: raw };
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –¥–∏–∞–ª–æ–≥–∞:', error.message);
      const recentMessages = conversationHistory
        .filter(msg => msg.role === 'user')
        .slice(-3)
        .map(msg => msg.content)
        .join('. ')
        .substring(0, 200);

      return { details: recentMessages || '–ö–ª–∏–µ–Ω—Ç –æ—Å—Ç–∞–≤–∏–ª —Ç–µ–ª–µ—Ñ–æ–Ω' };
    }
  }

  /**
   * –ò–∑–≤–ª–µ—á—å –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞
   */
  async extractContactPreference(conversationHistory) {
    try {
      if (!conversationHistory || conversationHistory.length === 0) {
        return '–Ω–µ —É–∫–∞–∑–∞–Ω';
      }

      const allMessages = conversationHistory
        .filter(msg => msg.role === 'user')
        .map(msg => msg.content)
        .join('\n');

      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç–æ–π regex
      const lowerMessages = allMessages.toLowerCase();
      if (lowerMessages.includes('telegram') || lowerMessages.includes('—Ç–µ–ª–µ–≥—Ä–∞–º') || lowerMessages.includes('—Ç–≥')) {
        return 'Telegram';
      }
      if (lowerMessages.includes('whatsapp') || lowerMessages.includes('–≤–∞—Ç—Å–∞–ø') || lowerMessages.includes('–≤–æ—Ç—Å–∞–ø') || lowerMessages.includes('–≤–∞—Ü–∞–ø')) {
        return 'WhatsApp';
      }
      if (lowerMessages.includes('–ø–æ–∑–≤–æ–Ω–∏') || lowerMessages.includes('–∑–≤–æ–Ω–æ–∫') || lowerMessages.includes('–∑–≤–æ–Ω–∏—Ç–µ') || lowerMessages.includes('–ø–µ—Ä–µ–∑–≤–æ–Ω–∏')) {
        return '–ó–≤–æ–Ω–æ–∫';
      }
      if (lowerMessages.includes('–≤ –≤–∫') || lowerMessages.includes('–≤–∫–æ–Ω—Ç–∞–∫—Ç–µ') || lowerMessages.includes('–∑–¥–µ—Å—å') || lowerMessages.includes('—Ç—É—Ç') || lowerMessages.includes('—Å—é–¥–∞')) {
        return '–í–ö';
      }
      if (lowerMessages.includes('–Ω–∞–ø–∏—à–∏') || lowerMessages.includes('—Å–º—Å') || lowerMessages.includes('—Å–æ–æ–±—â–µ–Ω–∏–µ')) {
        return '–°–æ–æ–±—â–µ–Ω–∏–µ';
      }

      return '–Ω–µ —É–∫–∞–∑–∞–Ω';
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–ø–æ—Å–æ–±–∞ —Å–≤—è–∑–∏:', error.message);
      return '–Ω–µ —É–∫–∞–∑–∞–Ω';
    }
  }
}

export default new AIService();
